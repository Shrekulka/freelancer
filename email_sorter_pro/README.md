# Задание на разработку программного обеспечения:

Требуется разработать программу для сортировки больших баз данных электронных почт (200 ГБ) по странам. Программа должна
быть настроена с помощью гибкого конфигурационного файла. Учитывая, что в одной стране может существовать несколько 
доменных зон или доменов, конфигурационный файл должен поддерживать правила для всех возможных вариантов доменных зон.

В случае, если программа не обнаружит соответствующего правила для какой-либо доменной зоны, электронные адреса с такими
доменами должны быть помещены в папку "Other" и записаны в файл "Other.txt".

Результатом работы программы должны быть папки для каждой страны, содержащие файлы с электронными адресами, относящимися
к каждой учтенной в конфигурации доменной зоне. Дополнительно должна быть создана папка "Other", содержащая файл 
"Other.txt" с электронными адресами, которые не были учтены в конфигурационном файле.

Если имеется сервис, предоставляющий информацию о том, какие доменные зоны принадлежат каждой стране, предусмотрите 
возможность интеграции этого сервиса для улучшения точности сортировки. Программа должна быть совместима с операционной 
системой Windows.

## **Описание решения:**

Программа представляет собой систему для сортировки большого количества email-адресов по странам. Она использует 
асинхронное программирование для эффективной обработки данных и имеет гибкую систему конфигурации.

### Основные компоненты:

- Конфигурационный модуль (config.py)
- Модуль сортировки (email_sorter.py)
- API для определения страны по домену (country_api.py)
- Генератор тестовых данных (generate_test_data.py)
- Главный скрипт (main.py)


## **Настройки в коде:**

### В файле config.py можно настроить следующие параметры:

- COUNTRIES: словарь соответствия доменов странам
  (Пример: {'ru': 'Russia', 'de': 'Germany'})
- API_SERVICE: настройки API-сервиса
  (URL, ключи доступа и т.д.)
- GENERATE_TEST_DATA: флаг генерации тестовых данных
  (True/False)
- TEST_DATA_COUNT: количество тестовых email-адресов
  (Целое число, например 1000)
- INPUT_FILES: список входных файлов
  (Пример: ['data/emails1.txt', 'data/emails2.txt'])
- OUTPUT_DIR: директория для выходных файлов
  (Путь к директории, например '/app/output')
- USE_API: флаг использования API
  (True/False)
- CHUNK_SIZE: размер чанка для обработки файлов
  (В байтах, например 1048576 для 1 МБ)
- MAX_CONCURRENT_REQUESTS: максимальное количество одновременных запросов к API
  (Целое число, например 10)
- SAVE_STATE_INTERVAL: интервал сохранения состояния
  (Количество обработанных email-адресов, например 10000)
- MAX_WORKERS: количество рабочих потоков
  (Целое число, например 4)

## **Последовательность выполнения кода:**

a) Скрипт main.py запускается
b) Загружается конфигурация из config.py
c) Если включена генерация тестовых данных, запускается generate_test_emails()
d) Создается экземпляр EmailSorter
e) Формируется список входных файлов
f) Запускается метод sort_emails() для обработки файлов
g) EmailSorter обрабатывает файлы асинхронно, сортируя email-адреса по странам
h) При необходимости, используется API для определения страны по домену
i) Результаты сортировки сохраняются в соответствующие файлы и директории
j) Периодически сохраняется состояние обработки
k) На каждом этапе выполнения происходит логирование процесса и обработка возможных ошибок



## **Инструкция для запуска кода на Windows и macOS с различными конфигурационными вариантами:**

### Общие шаги для Windows и macOS:

1. Убедитесь, что у вас установлен Docker:
- Для Windows: Docker Desktop for Windows
- Для macOS: Docker Desktop for Mac


2. Склонируйте или скачайте проект в локальную директорию.

3. Откройте терминал (командную строку в Windows или Terminal в macOS) и перейдите в директорию проекта.

4. Соберите Docker-образ:
    ```bash
    docker build -t email-sorter .
    ```
   
### Запуск на Windows:

**Вариант 1:** Базовый запуск
```bash
docker run email-sorter
```

**Вариант 2:** Запуск с монтированием локальных директорий
```bash
dockerrun -v "%cd%\data:/app/data" -v "%cd%\output:/app/output" email-sorter
```

**Вариант 3:** Запуск в фоновом режиме с маппингом портов
```bash
docker run -d -p 8080:80 -v "%cd%\data:/app/data" -v "%cd%\output:/app/output" email-sorter
```

**Вариант 4:** Запуск с переопределением конфигурации
```bash
docker run -e USE_API=false -e MAX_WORKERS=4 -v "%cd%\data:/app/data" -v "%cd%\output:/app/output" email-sorter
```

### Запуск на macOS:

**Вариант 1:** Базовый запуск
```bash
docker run email-sorter
```

**Вариант 2:** Запуск с монтированием локальных директорий
```bash
docker run -v "$(pwd)/data:/app/data" -v "$(pwd)/output:/app/output" email-sorter
```

**Вариант 3:** Запуск в фоновом режиме с маппингом портов
```bash
docker run -d -p 8080:80 -v "$(pwd)/data:/app/data" -v "$(pwd)/output:/app/output" email-sorter
```

**Вариант 4:** Запуск с переопределением конфигурации
```bash
docker run -e USE_API=false -e MAX_WORKERS=4 -v "$(pwd)/data:/app/data" -v "$(pwd)/output:/app/output" email-sorter
```

### Дополнительные конфигурационные варианты:

1. Изменение входных файлов:
- Отредактируйте config.py и измените INPUT_FILES
- Или передайте переменную окружения:
```bash
docker run -e INPUT_FILES='["data/new_emails.txt"]' -v "$(pwd)/data:/app/data" -v "$(pwd)/output:/app/output" email-sorter
```

2. Изменение выходной директории:
- Измените значение переменной OUTPUT_DIR в файле config.py
- Или используйте переменную окружения при запуске Docker-контейнера:
```bash
docker run -e OUTPUT_DIR='/app/custom_output' -v "$(pwd)/data:/app/data" -v "$(pwd)/custom_output:/app/custom_output" email-sorter
```

3. Включение или выключение использования API:
- Используйте переменную окружения при запуске Docker-контейнера:
```bash
docker run -e USE_API=true -v "$(pwd)/data:/app/data" -v "$(pwd)/output:/app/output" email-sorter
```

4. Изменение размера чанка для обработки данных:
- Установите значение CHUNK_SIZE через переменную окружения при запуске Docker-контейнера:
```bash
docker run -e CHUNK_SIZE=5242880 -v "$(pwd)/data:/app/data" -v "$(pwd)/output:/app/output" email-sorter
```

5. Установка максимального количества одновременных запросов к API:
- Задайте значение MAX_CONCURRENT_REQUESTS через переменную окружения при запуске Docker-контейнера:
```bash
docker run -e MAX_CONCURRENT_REQUESTS=50 -v "$(pwd)/data:/app/data" -v "$(pwd)/output:/app/output" email-sorter
```

6. Изменение интервала сохранения состояния обработки:
- Установите значение SAVE_STATE_INTERVAL через переменную окружения при запуске Docker-контейнера:
```bash
docker run -e SAVE_STATE_INTERVAL=500000 -v "$(pwd)/data:/app/data" -v "$(pwd)/output:/app/output" email-sorter
```

Обратите внимание, что в каждой команде мы используем флаги -v для монтирования локальных директорий внутрь контейнера. 
Это обеспечивает доступ к входным данным и сохранение выходных данных на вашем локальном компьютере.

Вы можете комбинировать эти опции в одной команде, 
например:
```bash
bashCopydocker run -e INPUT_FILES='["data/new_emails.txt"]' -e OUTPUT_DIR='/app/custom_output' -e USE_API=true -e 
CHUNK_SIZE=5242880 -e MAX_CONCURRENT_REQUESTS=50 -e SAVE_STATE_INTERVAL=500000 -v "$(pwd)/data:/app/data" -v 
"$(pwd)/custom_output:/app/custom_output" email-sorter
```
Эта команда запустит контейнер с измененными входными файлами, пользовательской выходной директорией, включенным API, 
измененным размером чанка, ограниченным количеством одновременных запросов и измененным интервалом сохранения состояния.

## **Инструкция для запуска кода на Windows и macOS:**

## Установка зависимостей без Docker

Если вы предпочитаете запускать программу без использования Docker, выполните следующие шаги:

1. Убедитесь, что у вас установлен Python 3.12.0 или выше.

2. Создайте виртуальное окружение:
   ```bash
   python -m venv venv
   source venv/bin/activate  # для Linux/macOS
   venv\Scripts\activate     # для Windows
   ```

3. Установите зависимости:
```bash
pip install -r requirements.txt
```

Запустите программу:
```bash
python main.py
```

## Структура проекта:

```bash
📁 email_sorter_pro/              # Корневая директория проекта
│
├── 📁 src/                       # Исходный код проекта
│   │
│   ├── 📁 sorter/                # Модуль сортировки
│   │   ├── __init__.py           # Инициализация модуля
│   │   ├── email_sorter.py       # Основной класс сортировщика
│   │   └── utils.py              # Вспомогательные функции
│   │
│   ├── 📁 config/                # Конфигурационные файлы
│   │   ├── __init__.py           # Инициализация модуля
│   │   ├── config.py             # Основные настройки
│   │   └── logger_config.py      # Настройки логирования
│   │
│   ├── 📁 api/                   # API для определения страны
│   │   ├── __init__.py           # Инициализация модуля
│   │   └── country_api.py        # Реализация API
│   │
│   └── __init__.py               # Инициализация пакета src
│
├── 📁 output/                    # Директория для выходных данных
│   └── 📁 sorted_emails/         # Отсортированные email-адреса
│       └── ...                   # Файлы с результатами
│
├── 📁 scripts/                   # Вспомогательные скрипты
│   └── generate_test_data.py     # Генератор тестовых данных
│
├── 📁 tests/                     # Тестовые данные и модульные тесты
│   ├── test_emails.txt           # Тестовый набор email-адресов
│   └── test_emails_1.txt         # Дополнительный набор для тестов
│
├── 📁 state/                     # Хранение состояния обработки
│
├── 📁 venv/                      # Виртуальное окружение Python
│
├── Dockerfile                    # Файл для сборки Docker-образа
├── .gitignore                    # Файл игнорирования Git
├── README.md                     # Документация проекта
├── requirements.txt              # Зависимости Python
└── main.py                       # Точка входа в приложение        
```